/*!
 * ctrly v0.4.0
 * Copyright (c) 2018 Jan Sorgalla
 * License: MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.ctrly=t()}(this,function(){"use strict";function v(){try{var e=document.activeElement;return e&&e.nodeName?e:document.body}catch(e){return document.body}}function r(e){for(var t=[];e&&e.parentNode&&1===e.parentNode.nodeType;)e=e.parentNode,t.push(e);return t}function b(e){var t,n;(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).restoreScrollPosition&&(n=r(e).map(function(e){return[e,e.scrollTop,e.scrollLeft]}),t=function(){n.forEach(function(e){e[0].scrollTop=e[1],e[0].scrollLeft=e[2]})});try{e.focus()}catch(e){}t&&t()}function h(e,t){var n=1<arguments.length?t:document;return n&&"function"==typeof n.querySelectorAll?[].slice.call(n.querySelectorAll(e)):[]}function n(e,t){if(!e)return!1;var n=e.matches||e.webkitMatchesSelector||e.msMatchesSelector;return"function"==typeof n&&n.call(e,t)}function m(e,t){if(!e)return null;if("function"==typeof e.closest)return e.closest(t);do{if(n(e,t))return e;e=e.parentNode}while(e&&1===e.nodeType);return null}var t;function a(){if(t)return t;t={capture:!1,once:!1,passive:!1};var e={get capture(){return!(t.capture=!0)},get once(){return!(t.once=!0)},get passive(){return!(t.passive=!0)}};return window.addEventListener("test",e,e),window.removeEventListener("test",e,e),t}function y(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=a(),n=t.once,r=t.passive,o=t.capture;return n||r||o?(n||delete e.once,r||delete e.passive,o||delete e.capture,e):Boolean(e.capture)}function g(t,e,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{capture:!1};if(!t||"function"!=typeof t.addEventListener)return function(){};var o=n,i=function(){!function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{capture:!1};e&&"function"==typeof e.removeEventListener&&e.removeEventListener(t,n,y(r))}(t,e,o,r)};return r.once&&!a().once&&(o=function(e){i(),n.call(t,e)}),t.addEventListener(e,o,y(r)),i}var o=["a[href]","area[href]","input","select","textarea","button","iframe","object","audio[controls]","video[controls]","[contenteditable]","[tabindex]"].join(","),i=/^(input|select|textarea|button|object)$/;function u(e){var t=e.nodeName.toLowerCase();if("area"===t)return function(e){var t=e.parentNode,n=t.name;if(!e.href||!n||"map"!==t.nodeName.toLowerCase())return!1;var r=h('img[usemap="#'.concat(n,'"]'));return 0<r.length&&s(r[0])}(e);if(e.disabled)return!1;if(i.test(t)){var n=m(e,"fieldset");if(n&&n.disabled)return!1}return s(e)}function c(e){var t=d(e);return u(e)&&0<=t}function l(e,t){var n=d(e,!0),r=d(t,!0);return n===r?2&e.compareDocumentPosition(t)?1:-1:n-r}function s(e){var t=getComputedStyle(e);return"hidden"!==t.visibility&&"collapse"!==t.visibility&&"none"!==t.display&&r(e).every(function(e){return"none"!==getComputedStyle(e).display})}function d(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=parseInt(e.getAttribute("tabindex"),10);return isNaN(n)?0:t&&n<0?0:n}function A(e){return h(o,0<arguments.length?e:document).filter(c).sort(l)}var E={selector:"[data-ctrly]",context:null,focusTarget:!0,closeOnBlur:!0,closeOnEsc:!0,closeOnOutsideClick:!0,closeOnScroll:!1,trapFocus:!1,allowMultiple:!1,on:null,autoInit:!0};function w(e){return"which"in e?e.which:e.keyCode}function x(e){return h('[aria-controls="'.concat(e.id,'"]'))}function O(e){return document.getElementById(e.getAttribute("aria-controls")||e.getAttribute("data-ctrly"))}function L(e){e.removeAttribute("aria-controls"),e.removeAttribute("aria-expanded")}var C=0;return function(){var n,t,e,r,o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=(n={},[E,o].forEach(function(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t])}),n),u=a.selector,i=a.on||{},c={};function l(e,t){return("function"!=typeof i[t]||!1!==i[t](e))&&!1!==function(e,t){var n,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(!e||"function"!=typeof e.dispatchEvent)return!0;r.bubbles=r.bubbles||!1,r.cancelable=r.cancelable||!1,r.composed=r.composed||!1,r.detail=r.detail||null;try{n=new CustomEvent(t,r)}catch(e){(n=document.createEvent("CustomEvent")).initCustomEvent(t,r.bubbles,r.cancelable,r.detail)}return e.dispatchEvent(n)}(e,"ctrly:".concat(t),{bubbles:!0,cancelable:!0})}function s(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(!e)return!1;if(!e.hasAttribute("data-ctrly-opened"))return!1;if(!l(e,"close"))return!1;var n=v(),r=c[e.id]||{},o=r.lastActiveElement,i=r.destroy;return delete c[e.id],i&&i(),x(e).forEach(function(e){e.setAttribute("aria-expanded","false")}),e.removeAttribute("data-ctrly-opened"),e.setAttribute("aria-hidden","true"),e.removeAttribute("tabindex"),e.blur(),t&&o&&e.contains(n)&&b(o,{restoreScrollPosition:!0}),l(e,"closed"),e}function d(n){var e;h(u,(e=n,a.context?m(e,a.context):document)).forEach(function(e){var t=O(e);t&&t.id!==n.id&&s(t,!1)})}function f(e){var t=O(e);return t?!t.hasAttribute("data-ctrly-opened")&&!!l(t,"open")&&(c[t.id]={lastActiveElement:v(),destroy:function(e,i){var t=[];if(a.closeOnBlur&&!a.trapFocus&&t.push(g(document,"focusin",function(e){i.contains(e.target)||s(i,!1)},{capture:!0,passive:!0})),a.closeOnEsc&&t.push(g(document,"keydown",function(e){27===w(e)&&s(i)&&e.preventDefault()})),a.closeOnOutsideClick&&t.push(g(document,"click",function(e){1!==w(e)||i.contains(e.target)||m(e.target,u)||s(i)},{passive:!0})),a.closeOnScroll){var n=!1,r=function(){n=!0},o=function(){n=!1};t.push(g(i,"mouseenter",r,{passive:!0})),t.push(g(i,"mouseleave",o,{passive:!0})),t.push(g(i,"touchstart",r,{passive:!0})),t.push(g(i,"touchend",o,{passive:!0})),t.push(g(window,"scroll",function(){n||s(i)},{passive:!0}))}return a.trapFocus&&t.push(g(document,"keydown",function(e){if(9===w(e)){var t=A(i);if(!t[0])return e.preventDefault(),void b(i);var n=v(),r=t[0],o=t[t.length-1];if(e.shiftKey&&n===r)return e.preventDefault(),void b(o);e.shiftKey||n!==o||(b(r),e.preventDefault())}})),function(){for(;t.length;)t.shift().call()}}(0,t)},x(t).forEach(function(e){e.setAttribute("aria-expanded","true")}),t.setAttribute("data-ctrly-opened",""),t.setAttribute("aria-hidden","false"),t.setAttribute("tabindex","-1"),l(t,"opened"),t):(L(e),!1)}function p(){t||(t=function(e,t,n,r){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{capture:!1},i=!0===o.once;delete o.once;var a=g(e,t,function(e){var t=m(e.target,n);t&&(i&&a(),r.call(t,e,t))},o);return a}(document,"click",u,function(e,t){if(1===w(e)){var n=O(t);n?"true"!==t.getAttribute("aria-expanded")?(a.allowMultiple||d(n),f(t),n&&(e.preventDefault(),a.focusTarget&&b(A(n)[0]||n),n.scrollTop=0,n.scrollLeft=0)):s(n)&&e.preventDefault():s(function(e){for(var t=e;t;){if(t.id&&c[t.id])return t;t=t.parentElement}}(t))&&e.preventDefault()}})),h(u).forEach(function(e){var t=O(e);if(t){e.setAttribute("aria-controls",t.id);var n=x(t).map(function(e){return e.id||e.setAttribute("id","ctrly-control-"+ ++C),e.id}),r=(t.getAttribute("aria-labelledby")||"").split(" ").concat(n).filter(function(e,t,n){return""!==e&&n.indexOf(e)===t});t.setAttribute("aria-labelledby",r.join(" ")),"true"===e.getAttribute("aria-expanded")||e.hasAttribute("data-ctrly-open")?f(e):(e.setAttribute("aria-expanded","false"),t.setAttribute("aria-hidden","true"),t.removeAttribute("tabindex"))}else L(e)})}return a.autoInit&&(e=p,"complete"!==(r=document.readyState)&&"interactive"!==r?document.addEventListener("DOMContentLoaded",function(){e()},y({capture:!0,once:!0,passive:!0})):setTimeout(e,0)),{init:p,destroy:function(){for(var e in t&&(t(),t=null),h(u).forEach(function(e){L(e);var t=O(e);t&&(s(t,!1),t.removeAttribute("aria-hidden"))}),c)Object.prototype.hasOwnProperty.call(c,e)&&(c[e].destroy(),delete c[e])}}}});
