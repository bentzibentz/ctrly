/*!
 * ctrly v0.6.0
 * Copyright (c) 2018 Jan Sorgalla
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ctrly=e()}(this,function(){"use strict";function m(){try{var t=document.activeElement;return t&&t.nodeName?t:document.body}catch(t){return document.body}}function r(t){for(var e=[];t&&t.parentNode&&1===t.parentNode.nodeType;)t=t.parentNode,e.push(t);return e}function y(t){var e,n;(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).restoreScrollPosition&&(n=r(t).map(function(t){return[t,t.scrollTop,t.scrollLeft]}),e=function(){n.forEach(function(t){t[0].scrollTop=t[1],t[0].scrollLeft=t[2]})});try{t.focus()}catch(t){}e&&e()}function A(t,e){if(!t)return!1;var n=t.matches||t.webkitMatchesSelector||t.msMatchesSelector;return"function"==typeof n&&n.call(t,e)}function g(t,e){if(!t)return null;if("function"==typeof t.closest)return t.closest(e);do{if(A(t,e))return t;t=t.parentNode}while(t&&1===t.nodeType);return null}function E(t,e){var n=1<arguments.length?e:document;return n&&"function"==typeof n.querySelectorAll?[].slice.call(n.querySelectorAll(t)):[]}var e,w=["a[href]","area[href]","input","select","textarea","button","iframe","object","audio[controls]","video[controls]","[contenteditable]","[tabindex]"].join(","),o=/^(input|select|textarea|button|object)$/;function n(t){var e=t.nodeName.toLowerCase();if("area"===e)return function(t){var e=t.parentNode,n=e.name;if(!t.href||!n||"map"!==e.nodeName.toLowerCase())return!1;var r=E('img[usemap="#'.concat(n,'"]'));return 0<r.length&&a(r[0])}(t);if(t.disabled)return!1;if(o.test(e)){var n=g(t,"fieldset");if(n&&n.disabled)return!1}return a(t)}function x(t){var e=u(t);return n(t)&&0<=e}function i(t,e){var n=u(t,!0),r=u(e,!0);return n===r?2&t.compareDocumentPosition(e)?1:-1:n-r}function a(t){var e=getComputedStyle(t);return"hidden"!==e.visibility&&"collapse"!==e.visibility&&"none"!==e.display&&r(t).every(function(t){return"none"!==getComputedStyle(t).display})}function u(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=parseInt(t.getAttribute("tabindex"),10);return isNaN(n)?0:e&&n<0?0:n}function c(){if(e)return e;e={capture:!1,once:!1,passive:!1};var t={get capture(){return!(e.capture=!0)},get once(){return!(e.once=!0)},get passive(){return!(e.passive=!0)}};return window.addEventListener("test",t,t),window.removeEventListener("test",t,t),e}function L(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=c(),n=e.once,r=e.passive,o=e.capture;return n||r||o?(n||delete t.once,r||delete t.passive,o||delete t.capture,t):Boolean(t.capture)}function O(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{capture:!1};if(!e||"function"!=typeof e.addEventListener)return function(){};var o=n,i=function(){!function(t,e,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{capture:!1};t&&"function"==typeof t.removeEventListener&&t.removeEventListener(e,n,L(r))}(e,t,o,r)};return r.once&&!c().once&&(o=function(t){i(),n.call(e,t)}),e.addEventListener(t,o,L(r)),i}function C(t,e,n,r){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{capture:!1},i=!0===o.once;delete o.once;var a=O(t,e,function(t){var e=g(t.target,n);e&&(i&&a(),r.call(e,t,e))},o);return a}function N(t){return E(w,0<arguments.length?t:document).filter(x).sort(i)}var S={selector:"[data-ctrly]",context:null,focusTarget:!0,closeOnBlur:!0,closeOnEsc:!0,closeOnOutsideClick:!0,closeOnScroll:!1,trapFocus:!1,allowMultiple:!1,on:null,autoInit:!0};function k(t){return"which"in t?t.which:t.keyCode}function D(t){return E('[aria-controls="'.concat(t.id,'"]'))}function T(t){return document.getElementById(t.getAttribute("aria-controls")||t.getAttribute("data-ctrly"))}function j(t){t.removeAttribute("aria-pressed"),t.removeAttribute("aria-controls"),t.removeAttribute("aria-expanded")}var M=0;return function(){var n,e,r,t,o,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=(n={},[S,i].forEach(function(t){for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(n[e]=t[e])}),n),u=a.selector,c=a.on||{},l={};function s(t,e){return("function"!=typeof c[e]||!1!==c[e](t))&&!1!==function(t,e){var n,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(!t||"function"!=typeof t.dispatchEvent)return!0;r.bubbles=r.bubbles||!1,r.cancelable=r.cancelable||!1,r.composed=r.composed||!1,r.detail=r.detail||null;try{n=new CustomEvent(e,r)}catch(t){(n=document.createEvent("CustomEvent")).initCustomEvent(e,r.bubbles,r.cancelable,r.detail)}return t.dispatchEvent(n)}(t,"ctrly:".concat(e),{bubbles:!0,cancelable:!0})}function d(t){var e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(!t)return!1;if(!t.hasAttribute("data-ctrly-opened"))return!1;if(!s(t,"close"))return!1;var n=m(),r=l[t.id]||{},o=r.lastActiveElement,i=r.destroy;return delete l[t.id],i&&i(),D(t).forEach(function(t){"button"!==t.tagName.toLowerCase()&&t.setAttribute("aria-pressed","false"),t.setAttribute("aria-expanded","false")}),t.removeAttribute("data-ctrly-opened"),t.setAttribute("aria-hidden","true"),t.removeAttribute("tabindex"),t.blur(),e&&o&&t.contains(n)&&y(o,{restoreScrollPosition:!0}),s(t,"closed"),t}function f(n){var t;E(u,(t=n,a.context?g(t,a.context):document)).forEach(function(t){var e=T(t);e&&e.id!==n.id&&d(e,!1)})}function p(t){var e=T(t);return e?!e.hasAttribute("data-ctrly-opened")&&!!s(e,"open")&&(l[e.id]={lastActiveElement:m(),destroy:function(t,i){var e=[];if(a.closeOnBlur&&!a.trapFocus&&e.push(O(document,"focusin",function(t){i.contains(t.target)||setTimeout(function(){d(i,!1)},0)},{capture:!0,passive:!0})),a.closeOnEsc&&e.push(O(document,"keydown",function(t){27===k(t)&&d(i)&&t.preventDefault()})),a.closeOnOutsideClick&&e.push(O(document,"click",function(t){1!==k(t)||i.contains(t.target)||g(t.target,u)||d(i)},{passive:!0})),a.closeOnScroll){var n=!1,r=function(){n=!0},o=function(){n=!1};e.push(O(i,"mouseenter",r,{passive:!0})),e.push(O(i,"mouseleave",o,{passive:!0})),e.push(O(i,"touchstart",r,{passive:!0})),e.push(O(i,"touchend",o,{passive:!0})),e.push(O(window,"scroll",function(){n||d(i)},{passive:!0}))}return a.trapFocus&&e.push(O(document,"keydown",function(t){if(9===k(t)){var e=N(i);if(!e[0])return t.preventDefault(),void y(i);var n=m(),r=e[0],o=e[e.length-1];if(t.shiftKey&&n===r)return t.preventDefault(),void y(o);t.shiftKey||n!==o||(y(r),t.preventDefault())}})),function(){for(;e.length;)e.shift().call()}}(0,e)},D(e).forEach(function(t){"button"!==t.tagName.toLowerCase()&&t.setAttribute("aria-pressed","true"),t.setAttribute("aria-expanded","true")}),e.setAttribute("data-ctrly-opened",""),e.setAttribute("aria-hidden","false"),e.setAttribute("tabindex","-1"),s(e,"opened"),e):(j(t),!1)}function v(t,e){var n=T(e);n?"true"!==e.getAttribute("aria-expanded")?(a.allowMultiple||f(n),p(e),n&&(t.preventDefault(),a.focusTarget&&y(N(n)[0]||n),n.scrollTop=0,n.scrollLeft=0)):d(n)&&t.preventDefault():d(function(t){for(var e=t;e;){if(e.id&&l[e.id])return e;e=e.parentElement}}(e))&&t.preventDefault()}function b(){e||(e=C(document,"click",u,function(t,e){1===k(t)&&v(t,e)}),r=C(document,"keypress",u,function(t,e){13!==k(t)&&32!==k(t)||v(t,e)})),E(u).forEach(function(t){var e=T(t);if(e){var n;"button"!==t.tagName.toLowerCase()&&(t.hasAttribute("role")||t.setAttribute("role","button"),A(n=t,w)&&x(n)||t.setAttribute("tabindex","0")),t.setAttribute("aria-controls",e.id);var r=D(e).map(function(t){return t.id||t.setAttribute("id","ctrly-control-"+ ++M),t.id}),o=(e.getAttribute("aria-labelledby")||"").split(" ").concat(r).filter(function(t,e,n){return""!==t&&n.indexOf(t)===e});e.setAttribute("aria-labelledby",o.join(" ")),"true"===t.getAttribute("aria-expanded")||t.hasAttribute("data-ctrly-open")?p(t):("button"!==t.tagName.toLowerCase()&&t.setAttribute("aria-pressed","false"),t.setAttribute("aria-expanded","false"),e.setAttribute("aria-hidden","true"),e.removeAttribute("tabindex"))}else j(t)})}function h(n){for(var t in n&&e&&(e(),e=null,r(),r=null),E(u).forEach(function(t){n&&j(t);var e=T(t);e&&(d(e,!1),n&&e.removeAttribute("aria-hidden"))}),l)Object.prototype.hasOwnProperty.call(l,t)&&(l[t].destroy(),delete l[t])}return a.autoInit&&(t=b,"complete"!==(o=document.readyState)&&"interactive"!==o?document.addEventListener("DOMContentLoaded",function(){t()},L({capture:!0,once:!0,passive:!0})):setTimeout(t,0)),{closeAll:function(){h(!1)},destroy:function(){h(!0)},init:b}}});
